#!/usr/bin/env python3
"""kill-port: Kill whatever's running on a port."""

import subprocess
import sys
import re


def find_process(port):
    """Find process using a port."""
    result = subprocess.run(
        ["lsof", "-i", f":{port}"],
        capture_output=True, text=True
    )

    lines = result.stdout.strip().split("\n")[1:]  # Skip header
    processes = []

    for line in lines:
        if line:
            parts = line.split()
            if len(parts) >= 2:
                name, pid = parts[0], parts[1]
                if pid.isdigit():
                    processes.append((name, int(pid)))

    return list(set(processes))


def kill_process(pid, force=False):
    """Kill a process by PID."""
    signal = "-9" if force else "-15"
    result = subprocess.run(["kill", signal, str(pid)], capture_output=True)
    return result.returncode == 0


def main():
    if len(sys.argv) < 2:
        print("Usage: kill-port <port> [-f]")
        print("  -f  Force kill (SIGKILL)")
        return

    port = sys.argv[1]
    force = "-f" in sys.argv

    if not port.isdigit():
        print(f"Invalid port: {port}")
        return

    processes = find_process(port)

    if not processes:
        print(f"Nothing running on port {port}")
        return

    for name, pid in processes:
        if kill_process(pid, force):
            print(f"Killed \033[1m{name}\033[0m (pid {pid}) on port {port}")
        else:
            print(f"Failed to kill {name} (pid {pid}) - try with -f")


if __name__ == "__main__":
    main()
